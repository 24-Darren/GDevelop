<html><!-- Created using the cpp_pretty_printer from the dlib C++ library.  See http://dclib.sf.net for updates. --><head><title>dlib C++ Library - server_http_1.h</title></head><body bgcolor='white'><pre>
<font color='#009900'>// Copyright (C) 2006  Davis E. King (davisking@users.sourceforge.net)
</font><font color='#009900'>// License: Boost Software License   See LICENSE.txt for the full license.
</font><font color='#0000FF'>#ifndef</font> DLIB_SERVER_HTTp_1_
<font color='#0000FF'>#define</font> DLIB_SERVER_HTTp_1_


<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='server_iostream_abstract.h.html'>server_iostream_abstract.h</a>"
<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='server_http_abstract.h.html'>server_http_abstract.h</a>"
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>iostream<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>sstream<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>string<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='../logger.h.html'>../logger.h</a>"

<font color='#0000FF'>#ifdef</font>  __INTEL_COMPILER
<font color='#009900'>// ignore the bogus warning about hiding on_connect()
</font><font color='#0000FF'>#pragma</font> warning <font face='Lucida Console'>(</font>disable: <font color='#979000'>1125</font><font face='Lucida Console'>)</font>
<font color='#0000FF'>#endif</font>

<font color='#0000FF'>namespace</font> dlib
<b>{</b>

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>
        <font color='#0000FF'>typename</font> server_base,
        <font color='#0000FF'>typename</font> map_ss_type,
        <font color='#0000FF'>typename</font> queue_string_type
        <font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>class</font> <b><a name='server_http_1'></a>server_http_1</b> : <font color='#0000FF'>public</font> server_base 
    <b>{</b>

        <font color='#009900'>/*!
            CONVENTION
                this extension doesn't add any new state to this object.
        !*/</font>


    <font color='#0000FF'>public</font>:
        <font color='#0000FF'>typedef</font> map_ss_type map_type;
        <font color='#0000FF'>typedef</font> queue_string_type queue_type;

    <font color='#0000FF'>private</font>:

        <font color='#0000FF'>virtual</font> <font color='#0000FF'><u>void</u></font> <b><a name='on_request'></a>on_request</b> <font face='Lucida Console'>(</font>
            <font color='#0000FF'>const</font> std::string<font color='#5555FF'>&amp;</font> path,
            std::string<font color='#5555FF'>&amp;</font> result,
            <font color='#0000FF'>const</font> map_type<font color='#5555FF'>&amp;</font> queries,
            <font color='#0000FF'>const</font> map_type<font color='#5555FF'>&amp;</font> cookies,
            queue_type<font color='#5555FF'>&amp;</font> new_cookies,
            <font color='#0000FF'>const</font> map_type<font color='#5555FF'>&amp;</font> incoming_headers,
            map_type<font color='#5555FF'>&amp;</font> response_headers,
            <font color='#0000FF'>const</font> std::string<font color='#5555FF'>&amp;</font> foreign_ip,
            <font color='#0000FF'>const</font> std::string<font color='#5555FF'>&amp;</font> local_ip,
            <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>short</u></font> foreign_port,
            <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>short</u></font> local_port
        <font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

        <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font> <b><a name='to_hex'></a>to_hex</b> <font face='Lucida Console'>(</font>
            <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font> ch
        <font face='Lucida Console'>)</font> <font color='#0000FF'>const</font>
        <b>{</b>
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ch <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> '<font color='#FF0000'>9</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> ch <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> '<font color='#FF0000'>0</font>'<font face='Lucida Console'>)</font>
                ch <font color='#5555FF'>-</font><font color='#5555FF'>=</font> '<font color='#FF0000'>0</font>';
            <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ch <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> '<font color='#FF0000'>f</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> ch <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> '<font color='#FF0000'>a</font>'<font face='Lucida Console'>)</font>
                ch <font color='#5555FF'>-</font><font color='#5555FF'>=</font> '<font color='#FF0000'>a</font>' <font color='#5555FF'>-</font> <font color='#979000'>10</font>;
            <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>ch <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> '<font color='#FF0000'>F</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> ch <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> '<font color='#FF0000'>A</font>'<font face='Lucida Console'>)</font>
                ch <font color='#5555FF'>-</font><font color='#5555FF'>=</font> '<font color='#FF0000'>A</font>' <font color='#5555FF'>-</font> <font color='#979000'>10</font>;
            <font color='#0000FF'>else</font> 
                ch <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
            <font color='#0000FF'>return</font> ch;
        <b>}</b>

        <font color='#0000FF'>const</font> std::string <b><a name='decode_query_string'></a>decode_query_string</b> <font face='Lucida Console'>(</font>
            <font color='#0000FF'>const</font> std::string<font color='#5555FF'>&amp;</font> str
        <font face='Lucida Console'>)</font> <font color='#0000FF'>const</font>
        <b>{</b>
            <font color='#0000FF'>using</font> <font color='#0000FF'>namespace</font> std;
            string result;
            string::size_type i;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> str.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>i<font face='Lucida Console'>)</font>
            <b>{</b>
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>str[i] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>+</font>'<font face='Lucida Console'>)</font>
                <b>{</b>
                    result <font color='#5555FF'>+</font><font color='#5555FF'>=</font> '<font color='#FF0000'> </font>';
                <b>}</b>
                <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>str[i] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>%</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> str.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> i<font color='#5555FF'>+</font><font color='#979000'>2</font><font face='Lucida Console'>)</font>
                <b>{</b>
                    <font color='#0000FF'>const</font> <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font> ch1 <font color='#5555FF'>=</font> <font color='#BB00BB'>to_hex</font><font face='Lucida Console'>(</font>str[i<font color='#5555FF'>+</font><font color='#979000'>1</font>]<font face='Lucida Console'>)</font>;
                    <font color='#0000FF'>const</font> <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font> ch2 <font color='#5555FF'>=</font> <font color='#BB00BB'>to_hex</font><font face='Lucida Console'>(</font>str[i<font color='#5555FF'>+</font><font color='#979000'>2</font>]<font face='Lucida Console'>)</font>;
                    <font color='#0000FF'>const</font> <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>char</u></font> ch <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>ch1 <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> <font color='#979000'>4</font><font face='Lucida Console'>)</font> <font color='#5555FF'>|</font> ch2;
                    result <font color='#5555FF'>+</font><font color='#5555FF'>=</font> ch;
                    i <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font color='#979000'>2</font>;
                <b>}</b>
                <font color='#0000FF'>else</font>
                <b>{</b>
                    result <font color='#5555FF'>+</font><font color='#5555FF'>=</font> str[i];
                <b>}</b>
            <b>}</b>
            <font color='#0000FF'>return</font> result;
        <b>}</b>

        <font color='#0000FF'><u>void</u></font> <b><a name='on_connect'></a>on_connect</b> <font face='Lucida Console'>(</font>
            std::istream<font color='#5555FF'>&amp;</font> in,
            std::ostream<font color='#5555FF'>&amp;</font> out,
            <font color='#0000FF'>const</font> std::string<font color='#5555FF'>&amp;</font> foreign_ip,
            <font color='#0000FF'>const</font> std::string<font color='#5555FF'>&amp;</font> local_ip,
            <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>short</u></font> foreign_port,
            <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>short</u></font> local_port,
            uint64
        <font face='Lucida Console'>)</font>
        <b>{</b>
            <font color='#0000FF'><u>bool</u></font> my_fault <font color='#5555FF'>=</font> <font color='#979000'>true</font>;
            <font color='#0000FF'>try</font>
            <b>{</b>
                <font color='#0000FF'>enum</font> <b><a name='req_type'></a>req_type</b> <b>{</b>get, post<b>}</b> rtype;

                <font color='#0000FF'>using</font> <font color='#0000FF'>namespace</font> std;
                map_type cookies;
                string word;
                string path;
                in <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> word;
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>word <font color='#5555FF'>=</font><font color='#5555FF'>=</font> "<font color='#CC0000'>GET</font>" <font color='#5555FF'>|</font><font color='#5555FF'>|</font> word <font color='#5555FF'>=</font><font color='#5555FF'>=</font> "<font color='#CC0000'>get</font>"<font face='Lucida Console'>)</font>
                <b>{</b>
                    rtype <font color='#5555FF'>=</font> get;
                <b>}</b>
                <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font> word <font color='#5555FF'>=</font><font color='#5555FF'>=</font> "<font color='#CC0000'>POST</font>" <font color='#5555FF'>|</font><font color='#5555FF'>|</font> word <font color='#5555FF'>=</font><font color='#5555FF'>=</font> "<font color='#CC0000'>post</font>"<font face='Lucida Console'>)</font>
                <b>{</b>
                    rtype <font color='#5555FF'>=</font> post;
                <b>}</b>
                <font color='#0000FF'>else</font>
                <b>{</b>
                    <font color='#009900'>// this isn't a GET or POST request so just drop the connection
</font>                    <font color='#0000FF'>return</font>;
                <b>}</b>

                <font color='#009900'>// get the path
</font>                in <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> path;

                <font color='#009900'>// now loop over all the incoming_headers
</font>                string line;
                <font color='#BB00BB'>getline</font><font face='Lucida Console'>(</font>in,line<font face='Lucida Console'>)</font>;
                <font color='#0000FF'><u>unsigned</u></font> <font color='#0000FF'><u>long</u></font> content_length <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                string content_type;
                map_type incoming_headers;
                string first_part_of_header;
                string::size_type position_of_double_point;
                <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>line.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> <font color='#979000'>2</font><font face='Lucida Console'>)</font>
                <b>{</b>
                    position_of_double_point <font color='#5555FF'>=</font> line.<font color='#BB00BB'>find_first_of</font><font face='Lucida Console'>(</font>'<font color='#FF0000'>:</font>'<font face='Lucida Console'>)</font>;
                    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font> position_of_double_point <font color='#5555FF'>!</font><font color='#5555FF'>=</font> string::npos <font face='Lucida Console'>)</font>
                    <b>{</b>
                        first_part_of_header <font color='#5555FF'>=</font> line.<font color='#BB00BB'>substr</font><font face='Lucida Console'>(</font><font color='#979000'>0</font>, position_of_double_point<font face='Lucida Console'>)</font>;
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font> incoming_headers.<font color='#BB00BB'>is_in_domain</font><font face='Lucida Console'>(</font>first_part_of_header<font face='Lucida Console'>)</font> <font face='Lucida Console'>)</font>
                        <b>{</b>
                            incoming_headers[ first_part_of_header ] <font color='#5555FF'>+</font><font color='#5555FF'>=</font> "<font color='#CC0000'> </font>" <font color='#5555FF'>+</font> line.<font color='#BB00BB'>substr</font><font face='Lucida Console'>(</font>position_of_double_point<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;
                        <b>}</b>
                        <font color='#0000FF'>else</font>
                        <b>{</b>
                            string <font color='#BB00BB'>second_part_of_header</font><font face='Lucida Console'>(</font>line.<font color='#BB00BB'>substr</font><font face='Lucida Console'>(</font>position_of_double_point<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                            incoming_headers.<font color='#BB00BB'>add</font><font face='Lucida Console'>(</font> first_part_of_header, second_part_of_header <font face='Lucida Console'>)</font>;
                        <b>}</b>

                        <font color='#009900'>// look for Content-Type:
</font>                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>line.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> <font color='#979000'>14</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                            line[<font color='#979000'>0</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>C</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                            line[<font color='#979000'>1</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>o</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                            line[<font color='#979000'>2</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>n</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                            line[<font color='#979000'>3</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>t</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                            line[<font color='#979000'>4</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>e</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                            line[<font color='#979000'>5</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>n</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                            line[<font color='#979000'>6</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>t</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                            line[<font color='#979000'>7</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>-</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                            <font face='Lucida Console'>(</font>line[<font color='#979000'>8</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>T</font>' <font color='#5555FF'>|</font><font color='#5555FF'>|</font> line[<font color='#979000'>8</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>t</font>'<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                            line[<font color='#979000'>9</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>y</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                            line[<font color='#979000'>10</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>p</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                            line[<font color='#979000'>11</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>e</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                            line[<font color='#979000'>12</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>:</font>' 
                        <font face='Lucida Console'>)</font>
                        <b>{</b>
                            content_type <font color='#5555FF'>=</font> line.<font color='#BB00BB'>substr</font><font face='Lucida Console'>(</font><font color='#979000'>14</font><font face='Lucida Console'>)</font>;
                            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>content_type[content_type.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#979000'>1</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>\r</font>'<font face='Lucida Console'>)</font>
                                content_type.<font color='#BB00BB'>erase</font><font face='Lucida Console'>(</font>content_type.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;
                        <b>}</b>
                        <font color='#009900'>// look for Content-Length:
</font>                        <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>line.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> <font color='#979000'>16</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                                 line[<font color='#979000'>0</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>C</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                                 line[<font color='#979000'>1</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>o</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                                 line[<font color='#979000'>2</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>n</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                                 line[<font color='#979000'>3</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>t</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                                 line[<font color='#979000'>4</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>e</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                                 line[<font color='#979000'>5</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>n</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                                 line[<font color='#979000'>6</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>t</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                                 line[<font color='#979000'>7</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>-</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                                 <font face='Lucida Console'>(</font>line[<font color='#979000'>8</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>L</font>' <font color='#5555FF'>|</font><font color='#5555FF'>|</font> line[<font color='#979000'>8</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>l</font>'<font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                                 line[<font color='#979000'>9</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>e</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                                 line[<font color='#979000'>10</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>n</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                                 line[<font color='#979000'>11</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>g</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                                 line[<font color='#979000'>12</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>t</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                                 line[<font color='#979000'>13</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>h</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                                 line[<font color='#979000'>14</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>:</font>' 
                        <font face='Lucida Console'>)</font>
                        <b>{</b>
                            istringstream <font color='#BB00BB'>sin</font><font face='Lucida Console'>(</font>line.<font color='#BB00BB'>substr</font><font face='Lucida Console'>(</font><font color='#979000'>16</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                            sin <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> content_length;
                            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>sin<font face='Lucida Console'>)</font>
                                content_length <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
                        <b>}</b>
                        <font color='#009900'>// look for any cookies
</font>                        <font color='#0000FF'>else</font> <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>line.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> <font color='#979000'>6</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                                 line[<font color='#979000'>0</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>C</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                                 line[<font color='#979000'>1</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>o</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                                 line[<font color='#979000'>2</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>o</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                                 line[<font color='#979000'>3</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>k</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                                 line[<font color='#979000'>4</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>i</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                                 line[<font color='#979000'>5</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>e</font>' <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                                 line[<font color='#979000'>6</font>] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>:</font>' 
                        <font face='Lucida Console'>)</font>
                        <b>{</b>
                            string::size_type pos <font color='#5555FF'>=</font> <font color='#979000'>6</font>;
                            string key, value;
                            <font color='#0000FF'><u>bool</u></font> seen_key_start <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
                            <font color='#0000FF'><u>bool</u></font> seen_equal_sign <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
                            <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>pos <font color='#5555FF'>+</font> <font color='#979000'>1</font> <font color='#5555FF'>&lt;</font> line.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                            <b>{</b>
                                <font color='#5555FF'>+</font><font color='#5555FF'>+</font>pos;
                                <font color='#009900'>// ignore whitespace between cookies
</font>                                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>seen_key_start <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> line[pos] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'> </font>'<font face='Lucida Console'>)</font>
                                    <font color='#0000FF'>continue</font>;

                                seen_key_start <font color='#5555FF'>=</font> <font color='#979000'>true</font>;
                                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>seen_equal_sign<font face='Lucida Console'>)</font> 
                                <b>{</b>
                                    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>line[pos] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>=</font>'<font face='Lucida Console'>)</font>
                                    <b>{</b>
                                        seen_equal_sign <font color='#5555FF'>=</font> <font color='#979000'>true</font>;
                                    <b>}</b>
                                    <font color='#0000FF'>else</font>
                                    <b>{</b>
                                        key <font color='#5555FF'>+</font><font color='#5555FF'>=</font> line[pos];
                                    <b>}</b>
                                <b>}</b>
                                <font color='#0000FF'>else</font>
                                <b>{</b>
                                    <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>line[pos] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>;</font>'<font face='Lucida Console'>)</font>
                                    <b>{</b>
                                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>cookies.<font color='#BB00BB'>is_in_domain</font><font face='Lucida Console'>(</font>key<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>false</font><font face='Lucida Console'>)</font>
                                            cookies.<font color='#BB00BB'>add</font><font face='Lucida Console'>(</font>key,value<font face='Lucida Console'>)</font>;
                                        seen_equal_sign <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
                                        seen_key_start <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
                                    <b>}</b>
                                    <font color='#0000FF'>else</font>
                                    <b>{</b>
                                        value <font color='#5555FF'>+</font><font color='#5555FF'>=</font> line[pos];
                                    <b>}</b>
                                <b>}</b>
                            <b>}</b>
                            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>key.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> cookies.<font color='#BB00BB'>is_in_domain</font><font face='Lucida Console'>(</font>key<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>false</font><font face='Lucida Console'>)</font>
                                cookies.<font color='#BB00BB'>add</font><font face='Lucida Console'>(</font>key,value<font face='Lucida Console'>)</font>;
                        <b>}</b>
                    <b>}</b> <font color='#009900'>// no ':' in it!
</font>                    <font color='#BB00BB'>getline</font><font face='Lucida Console'>(</font>in,line<font face='Lucida Console'>)</font>;
                <b>}</b> <font color='#009900'>// while (line.size() &gt; 2 )
</font>
                <font color='#009900'>// If there is data being posted back to us as a query string then
</font>                <font color='#009900'>// just stick it onto the end of the path so the following code can
</font>                <font color='#009900'>// then just pick it out like we do for GET requests.
</font>                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>rtype <font color='#5555FF'>=</font><font color='#5555FF'>=</font> post <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> content_type <font color='#5555FF'>=</font><font color='#5555FF'>=</font> "<font color='#CC0000'>application/x-www-form-urlencoded</font>" 
                    <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> content_length <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                <b>{</b>
                    line.<font color='#BB00BB'>resize</font><font face='Lucida Console'>(</font>content_length<font face='Lucida Console'>)</font>;
                    in.<font color='#BB00BB'>read</font><font face='Lucida Console'>(</font><font color='#5555FF'>&amp;</font>line[<font color='#979000'>0</font>],content_length<font face='Lucida Console'>)</font>;
                    path <font color='#5555FF'>+</font><font color='#5555FF'>=</font> "<font color='#CC0000'>?</font>" <font color='#5555FF'>+</font> line;
                <b>}</b>

                string result;
                map_type queries;
                string::size_type pos <font color='#5555FF'>=</font> path.<font color='#BB00BB'>find_first_of</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>?</font>"<font face='Lucida Console'>)</font>;
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>pos <font color='#5555FF'>!</font><font color='#5555FF'>=</font> string::npos<font face='Lucida Console'>)</font>
                <b>{</b>
                    word <font color='#5555FF'>=</font> path.<font color='#BB00BB'>substr</font><font face='Lucida Console'>(</font>pos<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font>;
                    path <font color='#5555FF'>=</font> path.<font color='#BB00BB'>substr</font><font face='Lucida Console'>(</font><font color='#979000'>0</font>,pos<font face='Lucida Console'>)</font>;
                    <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font>pos <font color='#5555FF'>=</font> <font color='#979000'>0</font>; pos <font color='#5555FF'>&lt;</font> word.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>pos<font face='Lucida Console'>)</font>
                    <b>{</b>
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>word[pos] <font color='#5555FF'>=</font><font color='#5555FF'>=</font> '<font color='#FF0000'>&amp;</font>'<font face='Lucida Console'>)</font>
                            word[pos] <font color='#5555FF'>=</font> '<font color='#FF0000'> </font>';
                    <b>}</b>

                    istringstream <font color='#BB00BB'>sin</font><font face='Lucida Console'>(</font>word<font face='Lucida Console'>)</font>;
                    sin <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> word;
                    <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>sin<font face='Lucida Console'>)</font>
                    <b>{</b>
                        pos <font color='#5555FF'>=</font> word.<font color='#BB00BB'>find_first_of</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>=</font>"<font face='Lucida Console'>)</font>;
                        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>pos <font color='#5555FF'>!</font><font color='#5555FF'>=</font> string::npos<font face='Lucida Console'>)</font>
                        <b>{</b>
                            string key <font color='#5555FF'>=</font> <font color='#BB00BB'>decode_query_string</font><font face='Lucida Console'>(</font>word.<font color='#BB00BB'>substr</font><font face='Lucida Console'>(</font><font color='#979000'>0</font>,pos<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                            string value <font color='#5555FF'>=</font> <font color='#BB00BB'>decode_query_string</font><font face='Lucida Console'>(</font>word.<font color='#BB00BB'>substr</font><font face='Lucida Console'>(</font>pos<font color='#5555FF'>+</font><font color='#979000'>1</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>queries.<font color='#BB00BB'>is_in_domain</font><font face='Lucida Console'>(</font>key<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>false</font><font face='Lucida Console'>)</font>
                                queries.<font color='#BB00BB'>add</font><font face='Lucida Console'>(</font>key,value<font face='Lucida Console'>)</font>;
                        <b>}</b>
                        sin <font color='#5555FF'>&gt;</font><font color='#5555FF'>&gt;</font> word;
                    <b>}</b>
                <b>}</b>


                my_fault <font color='#5555FF'>=</font> <font color='#979000'>false</font>;
                queue_type new_cookies;
                map_type response_headers;
                <font color='#009900'>// if there wasn't a problem with the input stream at some point
</font>                <font color='#009900'>// then lets trigger this request callback.
</font>                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>in<font face='Lucida Console'>)</font>
                    <font color='#BB00BB'>on_request</font><font face='Lucida Console'>(</font>path,result,queries,cookies,new_cookies,incoming_headers, response_headers, foreign_ip,local_ip,foreign_port,local_port<font face='Lucida Console'>)</font>;
                my_fault <font color='#5555FF'>=</font> <font color='#979000'>true</font>;

                out <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>HTTP/1.0 200 OK\r\n</font>";
                <font color='#009900'>// only send this header if the user hasn't told us to send another kind
</font>                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>response_headers.<font color='#BB00BB'>is_in_domain</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>Content-Type</font>"<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>false</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> 
                    response_headers.<font color='#BB00BB'>is_in_domain</font><font face='Lucida Console'>(</font>"<font color='#CC0000'>content-type</font>"<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>false</font><font face='Lucida Console'>)</font>
                <b>{</b>
                    out <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>Content-Type: text/html\r\n</font>";
                <b>}</b>
                out <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>Content-Length: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> result.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\r\n</font>";

                <font color='#009900'>// Set any new headers
</font>                response_headers.<font color='#BB00BB'>reset</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>response_headers.<font color='#BB00BB'>move_next</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                    out <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> response_headers.<font color='#BB00BB'>element</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>key</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> '<font color='#FF0000'>:</font>' <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> response_headers.<font color='#BB00BB'>element</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>.<font color='#BB00BB'>value</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\r\n</font>";

                <font color='#009900'>// set any cookies 
</font>                new_cookies.<font color='#BB00BB'>reset</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>;
                <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font>new_cookies.<font color='#BB00BB'>move_next</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                <b>{</b>
                    out <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>Set-Cookie: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> new_cookies.<font color='#BB00BB'>element</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\r\n</font>";
                <b>}</b>
                out <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\r\n</font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> result;
            <b>}</b>
            <font color='#0000FF'>catch</font> <font face='Lucida Console'>(</font>std::bad_alloc<font color='#5555FF'>&amp;</font><font face='Lucida Console'>)</font>
            <b>{</b>
                dlog <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> LERROR <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>We ran out of memory in server_http::on_connect()</font>";
                <font color='#009900'>// If this is an escaped exception from on_request then let it fly! 
</font>                <font color='#009900'>// Seriously though, this way it is obvious to the user that something bad happened
</font>                <font color='#009900'>// since they probably won't have the dlib logger enabled.
</font>                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font><font color='#5555FF'>!</font>my_fault<font face='Lucida Console'>)</font>
                    <font color='#0000FF'>throw</font>;
            <b>}</b>

        <b>}</b>

        <font color='#0000FF'>const</font> <font color='#0000FF'>static</font> logger dlog;
    <b>}</b>;

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>
        <font color='#0000FF'>typename</font> server_base,
        <font color='#0000FF'>typename</font> map_ss_type,
        <font color='#0000FF'>typename</font> queue_string_type
        <font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>const</font> logger server_http_1<font color='#5555FF'>&lt;</font>server_base,map_ss_type,queue_string_type<font color='#5555FF'>&gt;</font>::<b><a name='dlog'></a>dlog</b><font face='Lucida Console'>(</font>"<font color='#CC0000'>dlib.server</font>"<font face='Lucida Console'>)</font>;
<b>}</b>

<font color='#0000FF'>#endif</font> <font color='#009900'>// DLIB_SERVER_HTTp_1_
</font>




</pre></body></html>