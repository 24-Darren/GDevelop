<html><!-- Created using the cpp_pretty_printer from the dlib C++ library.  See http://dclib.sf.net for updates. --><head><title>dlib C++ Library - optimization.h</title></head><body bgcolor='white'><pre>
<font color='#009900'>// Copyright (C) 2008  Davis E. King (davisking@users.sourceforge.net)
</font><font color='#009900'>// License: Boost Software License   See LICENSE.txt for the full license.
</font><font color='#0000FF'>#ifndef</font> DLIB_OPTIMIZATIOn_H_
<font color='#0000FF'>#define</font> DLIB_OPTIMIZATIOn_H_

<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>cmath<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#include</font> <font color='#5555FF'>&lt;</font>limits<font color='#5555FF'>&gt;</font>
<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='../matrix.h.html'>../matrix.h</a>"
<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='../algs.h.html'>../algs.h</a>"
<font color='#0000FF'>#include</font> "<a style='text-decoration:none' href='optimization_abstract.h.html'>optimization_abstract.h</a>"

<font color='#0000FF'>namespace</font> dlib
<b>{</b>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font><font color='#009900'>// ----------------------------------------------------------------------------------------
</font><font color='#009900'>//                    Functions that transform other functions  
</font><font color='#009900'>// ----------------------------------------------------------------------------------------
</font><font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> funct<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>class</font> <b><a name='central_differences'></a>central_differences</b>
    <b>{</b>
    <font color='#0000FF'>public</font>:
        <font color='#009900'>// You get an error on this line when you pass in a global function to this function.
</font>        <font color='#009900'>// You have to either use a function object or pass a pointer to your global function
</font>        <font color='#009900'>// by taking its address using the &amp; operator.
</font>        <b><a name='COMPILE_TIME_ASSERT'></a>COMPILE_TIME_ASSERT</b><font face='Lucida Console'>(</font>is_function<font color='#5555FF'>&lt;</font>funct<font color='#5555FF'>&gt;</font>::value <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>false</font><font face='Lucida Console'>)</font>;

        <b><a name='central_differences'></a>central_differences</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> funct<font color='#5555FF'>&amp;</font> f_, <font color='#0000FF'><u>double</u></font> eps_ <font color='#5555FF'>=</font> <font color='#979000'>1</font>e<font color='#5555FF'>-</font><font color='#979000'>7</font><font face='Lucida Console'>)</font> : f<font face='Lucida Console'>(</font>f_<font face='Lucida Console'>)</font>, eps<font face='Lucida Console'>(</font>eps_<font face='Lucida Console'>)</font><b>{</b><b>}</b>

        <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
        <font color='#0000FF'>typename</font> T::matrix_type <b><a name='operator'></a>operator</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> T<font color='#5555FF'>&amp;</font> x<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font>
        <b>{</b>
            <font color='#009900'>// T must be some sort of dlib matrix 
</font>            <font color='#BB00BB'>COMPILE_TIME_ASSERT</font><font face='Lucida Console'>(</font>is_matrix<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value<font face='Lucida Console'>)</font>;

            <font color='#0000FF'>typename</font> T::matrix_type <font color='#BB00BB'>der</font><font face='Lucida Console'>(</font>x.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>typename</font> T::matrix_type <font color='#BB00BB'>e</font><font face='Lucida Console'>(</font>x.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
            <font color='#BB00BB'>set_all_elements</font><font face='Lucida Console'>(</font>e,<font color='#979000'>0</font><font face='Lucida Console'>)</font>;
            <font color='#0000FF'>for</font> <font face='Lucida Console'>(</font><font color='#0000FF'><u>long</u></font> i <font color='#5555FF'>=</font> <font color='#979000'>0</font>; i <font color='#5555FF'>&lt;</font> x.<font color='#BB00BB'>size</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>; <font color='#5555FF'>+</font><font color='#5555FF'>+</font>i<font face='Lucida Console'>)</font>
            <b>{</b>
                <font color='#BB00BB'>e</font><font face='Lucida Console'>(</font>i<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#979000'>1</font>;
                <font color='#BB00BB'>der</font><font face='Lucida Console'>(</font>i<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>f</font><font face='Lucida Console'>(</font>x<font color='#5555FF'>+</font>e<font color='#5555FF'>*</font>eps<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#BB00BB'>f</font><font face='Lucida Console'>(</font>x<font color='#5555FF'>-</font>e<font color='#5555FF'>*</font>eps<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>/</font><font face='Lucida Console'>(</font><font color='#979000'>2</font><font color='#5555FF'>*</font>eps<font face='Lucida Console'>)</font>;
                <font color='#BB00BB'>e</font><font face='Lucida Console'>(</font>i<font face='Lucida Console'>)</font> <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
            <b>}</b>

            <font color='#0000FF'>return</font> der;
        <b>}</b>

        <font color='#0000FF'><u>double</u></font> <b><a name='operator'></a>operator</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>double</u></font><font color='#5555FF'>&amp;</font> x<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font>
        <b>{</b>
            <font color='#0000FF'>return</font> <font face='Lucida Console'>(</font><font color='#BB00BB'>f</font><font face='Lucida Console'>(</font>x<font color='#5555FF'>+</font>eps<font face='Lucida Console'>)</font><font color='#5555FF'>-</font><font color='#BB00BB'>f</font><font face='Lucida Console'>(</font>x<font color='#5555FF'>-</font>eps<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>/</font><font face='Lucida Console'>(</font><font color='#979000'>2</font><font color='#5555FF'>*</font>eps<font face='Lucida Console'>)</font>;
        <b>}</b>

    <font color='#0000FF'>private</font>:
        <font color='#0000FF'>const</font> funct<font color='#5555FF'>&amp;</font> f;
        <font color='#0000FF'>const</font> <font color='#0000FF'><u>double</u></font> eps;
    <b>}</b>;

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> funct<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>const</font> central_differences<font color='#5555FF'>&lt;</font>funct<font color='#5555FF'>&gt;</font> <b><a name='derivative'></a>derivative</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> funct<font color='#5555FF'>&amp;</font> f<font face='Lucida Console'>)</font> <b>{</b> <font color='#0000FF'>return</font> central_differences<font color='#5555FF'>&lt;</font>funct<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>f<font face='Lucida Console'>)</font>; <b>}</b>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> funct<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>const</font> central_differences<font color='#5555FF'>&lt;</font>funct<font color='#5555FF'>&gt;</font> <b><a name='derivative'></a>derivative</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> funct<font color='#5555FF'>&amp;</font> f, <font color='#0000FF'><u>double</u></font> eps<font face='Lucida Console'>)</font> 
    <b>{</b> 
        <font color='#009900'>// You get an error on this line when you pass in a global function to this function.
</font>        <font color='#009900'>// You have to either use a function object or pass a pointer to your global function
</font>        <font color='#009900'>// by taking its address using the &amp; operator.
</font>        <font color='#BB00BB'>COMPILE_TIME_ASSERT</font><font face='Lucida Console'>(</font>is_function<font color='#5555FF'>&lt;</font>funct<font color='#5555FF'>&gt;</font>::value <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>false</font><font face='Lucida Console'>)</font>;

        <font color='#BB00BB'>DLIB_ASSERT</font> <font face='Lucida Console'>(</font>
            eps <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font>,
            "<font color='#CC0000'>\tcentral_differences derivative(f,eps)</font>"
            <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\n\tYou must give an epsilon &gt; 0</font>"
            <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\n\teps:     </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> eps 
        <font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> central_differences<font color='#5555FF'>&lt;</font>funct<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>f,eps<font face='Lucida Console'>)</font>; 
    <b>}</b>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> funct, <font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>class</font> <b><a name='line_search_funct'></a>line_search_funct</b> 
    <b>{</b>
    <font color='#0000FF'>public</font>:
        <font color='#009900'>// You get an error on this line when you pass in a global function to this function.
</font>        <font color='#009900'>// You have to either use a function object or pass a pointer to your global function
</font>        <font color='#009900'>// by taking its address using the &amp; operator.
</font>        <b><a name='COMPILE_TIME_ASSERT'></a>COMPILE_TIME_ASSERT</b><font face='Lucida Console'>(</font>is_function<font color='#5555FF'>&lt;</font>funct<font color='#5555FF'>&gt;</font>::value <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>false</font><font face='Lucida Console'>)</font>;

        <b><a name='line_search_funct'></a>line_search_funct</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> funct<font color='#5555FF'>&amp;</font> f_, <font color='#0000FF'>const</font> T<font color='#5555FF'>&amp;</font> start_, <font color='#0000FF'>const</font> T<font color='#5555FF'>&amp;</font> direction_<font face='Lucida Console'>)</font> : f<font face='Lucida Console'>(</font>f_<font face='Lucida Console'>)</font>,start<font face='Lucida Console'>(</font>start_<font face='Lucida Console'>)</font>, direction<font face='Lucida Console'>(</font>direction_<font face='Lucida Console'>)</font>
        <b>{</b><b>}</b>

        <font color='#0000FF'><u>double</u></font> <b><a name='operator'></a>operator</b><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>double</u></font><font color='#5555FF'>&amp;</font> x<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font>
        <b>{</b>
            <font color='#0000FF'>return</font> <font color='#BB00BB'>get_value</font><font face='Lucida Console'>(</font><font color='#BB00BB'>f</font><font face='Lucida Console'>(</font>start <font color='#5555FF'>+</font> x<font color='#5555FF'>*</font>direction<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        <b>}</b>

    <font color='#0000FF'>private</font>:

        <font color='#0000FF'><u>double</u></font> <b><a name='get_value'></a>get_value</b> <font face='Lucida Console'>(</font><font color='#0000FF'>const</font> <font color='#0000FF'><u>double</u></font><font color='#5555FF'>&amp;</font> r<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font>
        <b>{</b>
            <font color='#0000FF'>return</font> r;
        <b>}</b>

        <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> U<font color='#5555FF'>&gt;</font>
        <font color='#0000FF'><u>double</u></font> <b><a name='get_value'></a>get_value</b> <font face='Lucida Console'>(</font><font color='#0000FF'>const</font> U<font color='#5555FF'>&amp;</font> r<font face='Lucida Console'>)</font> <font color='#0000FF'>const</font>
        <b>{</b>
            <font color='#009900'>// U should be a matrix type
</font>            <font color='#BB00BB'>COMPILE_TIME_ASSERT</font><font face='Lucida Console'>(</font>is_matrix<font color='#5555FF'>&lt;</font>U<font color='#5555FF'>&gt;</font>::value<font face='Lucida Console'>)</font>;

            <font color='#0000FF'>return</font> <font color='#BB00BB'>trans</font><font face='Lucida Console'>(</font>r<font face='Lucida Console'>)</font><font color='#5555FF'>*</font>direction;
        <b>}</b>

        <font color='#0000FF'>const</font> funct<font color='#5555FF'>&amp;</font> f;
        <font color='#0000FF'>const</font> T<font color='#5555FF'>&amp;</font> start;
        <font color='#0000FF'>const</font> T<font color='#5555FF'>&amp;</font> direction;
    <b>}</b>;

    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font><font color='#0000FF'>typename</font> funct, <font color='#0000FF'>typename</font> T<font color='#5555FF'>&gt;</font>
    <font color='#0000FF'>const</font> line_search_funct<font color='#5555FF'>&lt;</font>funct,T<font color='#5555FF'>&gt;</font> <b><a name='make_line_search_function'></a>make_line_search_function</b><font face='Lucida Console'>(</font><font color='#0000FF'>const</font> funct<font color='#5555FF'>&amp;</font> f, <font color='#0000FF'>const</font> T<font color='#5555FF'>&amp;</font> start, <font color='#0000FF'>const</font> T<font color='#5555FF'>&amp;</font> direction<font face='Lucida Console'>)</font> 
    <b>{</b> 
        <font color='#009900'>// You get an error on this line when you pass in a global function to this function.
</font>        <font color='#009900'>// You have to either use a function object or pass a pointer to your global function
</font>        <font color='#009900'>// by taking its address using the &amp; operator.
</font>        <font color='#BB00BB'>COMPILE_TIME_ASSERT</font><font face='Lucida Console'>(</font>is_function<font color='#5555FF'>&lt;</font>funct<font color='#5555FF'>&gt;</font>::value <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>false</font><font face='Lucida Console'>)</font>;

        <font color='#BB00BB'>COMPILE_TIME_ASSERT</font><font face='Lucida Console'>(</font>is_matrix<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value<font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>DLIB_ASSERT</font> <font face='Lucida Console'>(</font>
            start.<font color='#BB00BB'>nc</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> direction.<font color='#BB00BB'>nc</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>,
            "<font color='#CC0000'>\tline_search_funct make_line_search_function(f,start,direction)</font>"
            <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\n\tYou have to supply column vectors to this function</font>"
            <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\n\tstart.nc():     </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> start.<font color='#BB00BB'>nc</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>
            <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\n\tdirection.nc(): </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> direction.<font color='#BB00BB'>nc</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>
        <font face='Lucida Console'>)</font>;
        <font color='#0000FF'>return</font> line_search_funct<font color='#5555FF'>&lt;</font>funct,T<font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>f,start,direction<font face='Lucida Console'>)</font>; 
    <b>}</b>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font><font color='#009900'>// ----------------------------------------------------------------------------------------
</font><font color='#009900'>//                    Functions that perform unconstrained optimization 
</font><font color='#009900'>// ----------------------------------------------------------------------------------------
</font><font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
    <font color='#0000FF'>inline</font> <font color='#0000FF'><u>double</u></font> <b><a name='poly_min_extrap'></a>poly_min_extrap</b> <font face='Lucida Console'>(</font>
        <font color='#0000FF'><u>double</u></font> f0,
        <font color='#0000FF'><u>double</u></font> d0,
        <font color='#0000FF'><u>double</u></font> f1,
        <font color='#0000FF'><u>double</u></font> d1
    <font face='Lucida Console'>)</font>
    <b>{</b>
        <font color='#0000FF'>const</font> <font color='#0000FF'><u>double</u></font> n <font color='#5555FF'>=</font> <font color='#979000'>3</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>f1 <font color='#5555FF'>-</font> f0<font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> <font color='#979000'>2</font><font color='#5555FF'>*</font>d0 <font color='#5555FF'>-</font> d1;
        <font color='#0000FF'>const</font> <font color='#0000FF'><u>double</u></font> e <font color='#5555FF'>=</font> d0 <font color='#5555FF'>+</font> d1 <font color='#5555FF'>-</font> <font color='#979000'>2</font><font color='#5555FF'>*</font><font face='Lucida Console'>(</font>f1 <font color='#5555FF'>-</font> f0<font face='Lucida Console'>)</font>;


        <font color='#009900'>// find the minimum of the derivative of the polynomial
</font>
        <font color='#0000FF'><u>double</u></font> temp <font color='#5555FF'>=</font> std::<font color='#BB00BB'>max</font><font face='Lucida Console'>(</font>n<font color='#5555FF'>*</font>n <font color='#5555FF'>-</font> <font color='#979000'>3</font><font color='#5555FF'>*</font>e<font color='#5555FF'>*</font>d0,<font color='#979000'>0.0</font><font face='Lucida Console'>)</font>;

        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>temp <font color='#5555FF'>&lt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>return</font> <font color='#979000'>0.5</font>;

        temp <font color='#5555FF'>=</font> std::<font color='#BB00BB'>sqrt</font><font face='Lucida Console'>(</font>temp<font face='Lucida Console'>)</font>;

        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>std::<font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>e<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> std::numeric_limits<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>double</u></font><font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>epsilon</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>return</font> <font color='#979000'>0.5</font>;

        <font color='#009900'>// figure out the two possible min values
</font>        <font color='#0000FF'><u>double</u></font> x1 <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>temp <font color='#5555FF'>-</font> n<font face='Lucida Console'>)</font><font color='#5555FF'>/</font><font face='Lucida Console'>(</font><font color='#979000'>3</font><font color='#5555FF'>*</font>e<font face='Lucida Console'>)</font>;
        <font color='#0000FF'><u>double</u></font> x2 <font color='#5555FF'>=</font> <font color='#5555FF'>-</font><font face='Lucida Console'>(</font>temp <font color='#5555FF'>+</font> n<font face='Lucida Console'>)</font><font color='#5555FF'>/</font><font face='Lucida Console'>(</font><font color='#979000'>3</font><font color='#5555FF'>*</font>e<font face='Lucida Console'>)</font>;

        <font color='#009900'>// compute the value of the interpolating polynomial at these two points
</font>        <font color='#0000FF'><u>double</u></font> y1 <font color='#5555FF'>=</font> f0 <font color='#5555FF'>+</font> d0<font color='#5555FF'>*</font>x1 <font color='#5555FF'>+</font> n<font color='#5555FF'>*</font>x1<font color='#5555FF'>*</font>x1 <font color='#5555FF'>+</font> e<font color='#5555FF'>*</font>x1<font color='#5555FF'>*</font>x1<font color='#5555FF'>*</font>x1;
        <font color='#0000FF'><u>double</u></font> y2 <font color='#5555FF'>=</font> f0 <font color='#5555FF'>+</font> d0<font color='#5555FF'>*</font>x2 <font color='#5555FF'>+</font> n<font color='#5555FF'>*</font>x2<font color='#5555FF'>*</font>x2 <font color='#5555FF'>+</font> e<font color='#5555FF'>*</font>x2<font color='#5555FF'>*</font>x2<font color='#5555FF'>*</font>x2;

        <font color='#009900'>// pick the best point
</font>        <font color='#0000FF'><u>double</u></font> x;
        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>y1 <font color='#5555FF'>&lt;</font> y2<font face='Lucida Console'>)</font>
            x <font color='#5555FF'>=</font> x1;
        <font color='#0000FF'>else</font>
            x <font color='#5555FF'>=</font> x2;

        <font color='#009900'>// now make sure the minimum is within the allowed range of (0,1) 
</font>        <font color='#0000FF'>return</font> <font color='#BB00BB'>put_in_range</font><font face='Lucida Console'>(</font><font color='#979000'>0</font>,<font color='#979000'>1</font>,x<font face='Lucida Console'>)</font>;
    <b>}</b>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>
        <font color='#0000FF'>typename</font> funct, 
        <font color='#0000FF'>typename</font> funct_der
        <font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>double</u></font> <b><a name='line_search'></a>line_search</b> <font face='Lucida Console'>(</font>
        <font color='#0000FF'>const</font> funct<font color='#5555FF'>&amp;</font> f, 
        <font color='#0000FF'>const</font> funct_der<font color='#5555FF'>&amp;</font> der, 
        <font color='#0000FF'><u>double</u></font> rho, 
        <font color='#0000FF'><u>double</u></font> sigma, 
        <font color='#0000FF'><u>double</u></font> minf,
        <font color='#0000FF'><u>double</u></font><font color='#5555FF'>&amp;</font> f0_out
    <font face='Lucida Console'>)</font>
    <b>{</b>
        <font color='#009900'>// You get an error on this line when you pass in a global function to this function.
</font>        <font color='#009900'>// You have to either use a function object or pass a pointer to your global function
</font>        <font color='#009900'>// by taking its address using the &amp; operator.
</font>        <font color='#BB00BB'>COMPILE_TIME_ASSERT</font><font face='Lucida Console'>(</font>is_function<font color='#5555FF'>&lt;</font>funct<font color='#5555FF'>&gt;</font>::value <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>false</font><font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>COMPILE_TIME_ASSERT</font><font face='Lucida Console'>(</font>is_function<font color='#5555FF'>&lt;</font>funct_der<font color='#5555FF'>&gt;</font>::value <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>false</font><font face='Lucida Console'>)</font>;

        <font color='#BB00BB'>DLIB_ASSERT</font> <font face='Lucida Console'>(</font>
            <font color='#979000'>1</font> <font color='#5555FF'>&gt;</font> sigma <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> sigma <font color='#5555FF'>&gt;</font> rho <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> rho <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font>,
            "<font color='#CC0000'>\tdouble line_search()</font>"
            <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\n\tYou have given invalid arguments to this function</font>"
            <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\n\tsigma: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> sigma
            <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\n\trho:   </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> rho 
        <font face='Lucida Console'>)</font>;

        <font color='#009900'>// The bracketing phase of this function is implemented according to block 2.6.2 from
</font>        <font color='#009900'>// the book Practical Methods of Optimization by R. Fletcher.   The sectioning 
</font>        <font color='#009900'>// phase is an implementation of 2.6.4 from the same book.
</font>
        <font color='#009900'>// tau1 &gt; 1. Controls the alpha jump size during the search
</font>        <font color='#0000FF'>const</font> <font color='#0000FF'><u>double</u></font> tau1 <font color='#5555FF'>=</font> <font color='#979000'>9</font>;

        <font color='#009900'>// it must be the case that 0 &lt; tau2 &lt; tau3 &lt;= 1/2 for the algorithm to function
</font>        <font color='#009900'>// correctly but the specific values of tau2 and tau3 aren't super important.
</font>        <font color='#0000FF'>const</font> <font color='#0000FF'><u>double</u></font> tau2 <font color='#5555FF'>=</font> <font color='#979000'>1.0</font><font color='#5555FF'>/</font><font color='#979000'>10.0</font>;
        <font color='#0000FF'>const</font> <font color='#0000FF'><u>double</u></font> tau3 <font color='#5555FF'>=</font> <font color='#979000'>1.0</font><font color='#5555FF'>/</font><font color='#979000'>2.0</font>;

        <font color='#0000FF'>const</font> <font color='#0000FF'><u>double</u></font> f0 <font color='#5555FF'>=</font> <font color='#BB00BB'>f</font><font face='Lucida Console'>(</font><font color='#979000'>0</font><font face='Lucida Console'>)</font>;
        <font color='#0000FF'>const</font> <font color='#0000FF'><u>double</u></font> d0 <font color='#5555FF'>=</font> <font color='#BB00BB'>der</font><font face='Lucida Console'>(</font><font color='#979000'>0</font><font face='Lucida Console'>)</font>;

        <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>std::<font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>d0<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font> std::numeric_limits<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>double</u></font><font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>epsilon</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
            <font color='#0000FF'>return</font> <font color='#979000'>0</font>;
        <font color='#009900'>//DLIB_CASSERT(d0 &lt; 0,d0);
</font>
        <font color='#0000FF'>const</font> <font color='#0000FF'><u>double</u></font> mu <font color='#5555FF'>=</font> <font face='Lucida Console'>(</font>minf<font color='#5555FF'>-</font>f0<font face='Lucida Console'>)</font><font color='#5555FF'>/</font><font face='Lucida Console'>(</font>rho<font color='#5555FF'>*</font>d0<font face='Lucida Console'>)</font>;


        f0_out <font color='#5555FF'>=</font> f0;


        <font color='#0000FF'><u>double</u></font> f1 <font color='#5555FF'>=</font> <font color='#BB00BB'>f</font><font face='Lucida Console'>(</font>mu<font face='Lucida Console'>)</font>;
        <font color='#0000FF'><u>double</u></font> d1 <font color='#5555FF'>=</font> <font color='#BB00BB'>der</font><font face='Lucida Console'>(</font>mu<font face='Lucida Console'>)</font>;
        <font color='#009900'>// pick the initial alpha by guessing at the minimum alpha 
</font>        <font color='#0000FF'><u>double</u></font> alpha <font color='#5555FF'>=</font> mu<font color='#5555FF'>*</font><font color='#BB00BB'>poly_min_extrap</font><font face='Lucida Console'>(</font>f0, d0, f1, d1<font face='Lucida Console'>)</font>;
        alpha <font color='#5555FF'>=</font> <font color='#BB00BB'>put_in_range</font><font face='Lucida Console'>(</font><font color='#979000'>0.1</font><font color='#5555FF'>*</font>mu, <font color='#979000'>0.9</font><font color='#5555FF'>*</font>mu, alpha<font face='Lucida Console'>)</font>;

        <font color='#BB00BB'>DLIB_CASSERT</font><font face='Lucida Console'>(</font>alpha <font color='#5555FF'>&lt;</font> std::numeric_limits<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>double</u></font><font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>infinity</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, 
                     "<font color='#CC0000'>alpha: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> alpha <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'> mu: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> mu <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'> f0: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> f0 <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'> d0: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> d0 <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'> f1: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> f1 <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'> d1: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> d1
                     <font face='Lucida Console'>)</font>;

        <font color='#0000FF'>using</font> <font color='#0000FF'>namespace</font> std;
        <font color='#009900'>//cout &lt;&lt; "alpha: " &lt;&lt; alpha &lt;&lt; " mu: " &lt;&lt; mu &lt;&lt; " f0: " &lt;&lt; f0 &lt;&lt; " d0: " &lt;&lt; d0 &lt;&lt; " f1: " &lt;&lt; f1 &lt;&lt; " d1: " &lt;&lt; d1 &lt;&lt; endl;
</font>
        <font color='#0000FF'><u>double</u></font> last_alpha <font color='#5555FF'>=</font> <font color='#979000'>0</font>;
        <font color='#0000FF'><u>double</u></font> last_val <font color='#5555FF'>=</font> f0;
        <font color='#0000FF'><u>double</u></font> last_val_der <font color='#5555FF'>=</font> d0;

        <font color='#009900'>// the bracketing stage will find a find a range of points [a,b]
</font>        <font color='#009900'>// that contains a reasonable solution to the line search
</font>        <font color='#0000FF'><u>double</u></font> a, b;

        <font color='#009900'>// the value of f(a)
</font>        <font color='#0000FF'><u>double</u></font> a_val, b_val, a_val_der, b_val_der;

        <font color='#0000FF'>const</font> <font color='#0000FF'><u>double</u></font> thresh <font color='#5555FF'>=</font> std::<font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>sigma<font color='#5555FF'>*</font>d0<font face='Lucida Console'>)</font>;

        <font color='#009900'>// do the bracketing stage to find the bracket range [a,b]
</font>        <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#979000'>true</font><font face='Lucida Console'>)</font>
        <b>{</b>
            <font color='#009900'>//cout &lt;&lt; "alpha: " &lt;&lt; alpha &lt;&lt; " mu: " &lt;&lt; mu &lt;&lt; " f0: " &lt;&lt; f0 &lt;&lt; " d0: " &lt;&lt; d0 &lt;&lt; " f1: " &lt;&lt; f1 &lt;&lt; " d1: " &lt;&lt; d1 &lt;&lt; endl;
</font>            <font color='#BB00BB'>DLIB_CASSERT</font><font face='Lucida Console'>(</font>alpha <font color='#5555FF'>&lt;</font> std::numeric_limits<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>double</u></font><font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>infinity</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, alpha<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>const</font> <font color='#0000FF'><u>double</u></font> val <font color='#5555FF'>=</font> <font color='#BB00BB'>f</font><font face='Lucida Console'>(</font>alpha<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>const</font> <font color='#0000FF'><u>double</u></font> val_der <font color='#5555FF'>=</font> <font color='#BB00BB'>der</font><font face='Lucida Console'>(</font>alpha<font face='Lucida Console'>)</font>;

            <font color='#009900'>// we are done with the line search since we found a value smaller
</font>            <font color='#009900'>// than the minimum f value
</font>            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>val <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> minf<font face='Lucida Console'>)</font>
                <font color='#0000FF'>return</font> alpha;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>val <font color='#5555FF'>&gt;</font> f0 <font color='#5555FF'>+</font> alpha<font color='#5555FF'>*</font>d0 <font color='#5555FF'>|</font><font color='#5555FF'>|</font> val <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> last_val<font face='Lucida Console'>)</font>
            <b>{</b>
                a_val <font color='#5555FF'>=</font> last_val;
                a_val_der <font color='#5555FF'>=</font> last_val_der;
                b_val <font color='#5555FF'>=</font> val;
                b_val_der <font color='#5555FF'>=</font> val_der;

                a <font color='#5555FF'>=</font> last_alpha;
                b <font color='#5555FF'>=</font> alpha;
                <font color='#0000FF'>break</font>;
            <b>}</b>

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>std::<font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>val_der<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> thresh<font face='Lucida Console'>)</font>
                <font color='#0000FF'>return</font> alpha;

            <font color='#009900'>// if we are stuck not making progress then quit with the current alpha
</font>            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>last_alpha <font color='#5555FF'>=</font><font color='#5555FF'>=</font> alpha<font face='Lucida Console'>)</font>
                <font color='#0000FF'>return</font> alpha;

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>val_der <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            <b>{</b>
                a_val <font color='#5555FF'>=</font> val;
                a_val_der <font color='#5555FF'>=</font> val_der;
                b_val <font color='#5555FF'>=</font> last_val;
                b_val_der <font color='#5555FF'>=</font> last_val_der;

                a <font color='#5555FF'>=</font> alpha;
                b <font color='#5555FF'>=</font> last_alpha;
                <font color='#0000FF'>break</font>;
            <b>}</b>

            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>mu <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> <font color='#979000'>2</font><font color='#5555FF'>*</font>alpha <font color='#5555FF'>-</font> last_alpha<font face='Lucida Console'>)</font>
            <b>{</b>
                last_alpha <font color='#5555FF'>=</font> alpha;
                alpha <font color='#5555FF'>=</font> mu;
            <b>}</b>
            <font color='#0000FF'>else</font>
            <b>{</b>
                <font color='#0000FF'>const</font> <font color='#0000FF'><u>double</u></font> temp <font color='#5555FF'>=</font> alpha;

                <font color='#0000FF'><u>double</u></font> first <font color='#5555FF'>=</font> <font color='#979000'>2</font><font color='#5555FF'>*</font>alpha <font color='#5555FF'>-</font> last_alpha;
                <font color='#0000FF'><u>double</u></font> last;
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>mu <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                    last <font color='#5555FF'>=</font> std::<font color='#BB00BB'>min</font><font face='Lucida Console'>(</font>mu, alpha <font color='#5555FF'>+</font> tau1<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>alpha <font color='#5555FF'>-</font> last_alpha<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
                <font color='#0000FF'>else</font>
                    last <font color='#5555FF'>=</font> std::<font color='#BB00BB'>max</font><font face='Lucida Console'>(</font>mu, alpha <font color='#5555FF'>+</font> tau1<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>alpha <font color='#5555FF'>-</font> last_alpha<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;


                <font color='#009900'>// pick a point between first and last by doing some kind of interpolation
</font>                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>last_alpha <font color='#5555FF'>&lt;</font> alpha<font face='Lucida Console'>)</font>
                    alpha <font color='#5555FF'>=</font> last_alpha <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>alpha<font color='#5555FF'>-</font>last_alpha<font face='Lucida Console'>)</font><font color='#5555FF'>*</font><font color='#BB00BB'>poly_min_extrap</font><font face='Lucida Console'>(</font>last_val, last_val_der, val, val_der<font face='Lucida Console'>)</font>;
                <font color='#0000FF'>else</font>
                    alpha <font color='#5555FF'>=</font> alpha <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>last_alpha<font color='#5555FF'>-</font>alpha<font face='Lucida Console'>)</font><font color='#5555FF'>*</font><font color='#BB00BB'>poly_min_extrap</font><font face='Lucida Console'>(</font>val, val_der, last_val, last_val_der<font face='Lucida Console'>)</font>;

                alpha <font color='#5555FF'>=</font> <font color='#BB00BB'>put_in_range</font><font face='Lucida Console'>(</font>first,last,alpha<font face='Lucida Console'>)</font>;


                last_alpha <font color='#5555FF'>=</font> temp;
            <b>}</b>

            last_val <font color='#5555FF'>=</font> val;
            last_val_der <font color='#5555FF'>=</font> val_der;

        <b>}</b>


        <font color='#BB00BB'>DLIB_CASSERT</font><font face='Lucida Console'>(</font>alpha <font color='#5555FF'>&lt;</font> std::numeric_limits<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>double</u></font><font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>infinity</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, 
                     "<font color='#CC0000'>alpha: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> alpha <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'> mu: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> mu <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'> f0: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> f0 <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'> d0: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> d0 <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'> f1: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> f1 <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'> d1: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> d1
                     <font face='Lucida Console'>)</font>;

        <font color='#009900'>// Now do the sectioning phase from 2.6.4
</font>        <font color='#0000FF'>while</font> <font face='Lucida Console'>(</font><font color='#979000'>true</font><font face='Lucida Console'>)</font>
        <b>{</b>
            <font color='#009900'>//cout &lt;&lt; "alpha: " &lt;&lt; alpha &lt;&lt; " mu: " &lt;&lt; mu &lt;&lt; " f0: " &lt;&lt; f0 &lt;&lt; " d0: " &lt;&lt; d0 &lt;&lt; " f1: " &lt;&lt; f1 &lt;&lt; " d1: " &lt;&lt; d1 &lt;&lt; endl;
</font>            <font color='#BB00BB'>DLIB_CASSERT</font><font face='Lucida Console'>(</font>alpha <font color='#5555FF'>&lt;</font> std::numeric_limits<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>double</u></font><font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>infinity</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>, 
                        "<font color='#CC0000'>alpha: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> alpha <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'> mu: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> mu <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'> f0: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> f0 <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'> d0: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> d0 <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'> f1: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> f1 <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'> d1: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> d1
                     <font face='Lucida Console'>)</font>;
            <font color='#0000FF'><u>double</u></font> first <font color='#5555FF'>=</font> a <font color='#5555FF'>+</font> tau2<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>b<font color='#5555FF'>-</font>a<font face='Lucida Console'>)</font>;
            <font color='#0000FF'><u>double</u></font> last <font color='#5555FF'>=</font> b <font color='#5555FF'>-</font> tau3<font color='#5555FF'>*</font><font face='Lucida Console'>(</font>b<font color='#5555FF'>-</font>a<font face='Lucida Console'>)</font>;

            <font color='#009900'>// use interpolation to pick alpha between first and last
</font>            alpha <font color='#5555FF'>=</font> a <font color='#5555FF'>+</font> <font face='Lucida Console'>(</font>b<font color='#5555FF'>-</font>a<font face='Lucida Console'>)</font><font color='#5555FF'>*</font><font color='#BB00BB'>poly_min_extrap</font><font face='Lucida Console'>(</font>a_val, a_val_der, b_val, b_val_der<font face='Lucida Console'>)</font>;
            alpha <font color='#5555FF'>=</font> <font color='#BB00BB'>put_in_range</font><font face='Lucida Console'>(</font>first,last,alpha<font face='Lucida Console'>)</font>;

            <font color='#0000FF'>const</font> <font color='#0000FF'><u>double</u></font> val <font color='#5555FF'>=</font> <font color='#BB00BB'>f</font><font face='Lucida Console'>(</font>alpha<font face='Lucida Console'>)</font>;
            <font color='#0000FF'>const</font> <font color='#0000FF'><u>double</u></font> val_der <font color='#5555FF'>=</font> <font color='#BB00BB'>der</font><font face='Lucida Console'>(</font>alpha<font face='Lucida Console'>)</font>;


            <font color='#009900'>// stop if the interval gets so small that it isn't shrinking any more due to rounding error 
</font>            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>a <font color='#5555FF'>=</font><font color='#5555FF'>=</font> first <font color='#5555FF'>|</font><font color='#5555FF'>|</font> b <font color='#5555FF'>=</font><font color='#5555FF'>=</font> last<font face='Lucida Console'>)</font>
            <b>{</b>
                <font color='#0000FF'>return</font> b;
            <b>}</b>


            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>val <font color='#5555FF'>&gt;</font> f0 <font color='#5555FF'>+</font> rho<font color='#5555FF'>*</font>alpha<font color='#5555FF'>*</font>d0 <font color='#5555FF'>|</font><font color='#5555FF'>|</font> val <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> a_val<font face='Lucida Console'>)</font>
            <b>{</b>
                b <font color='#5555FF'>=</font> alpha;
                b_val <font color='#5555FF'>=</font> val;
                b_val_der <font color='#5555FF'>=</font> val_der;
            <b>}</b>
            <font color='#0000FF'>else</font>
            <b>{</b>
                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>std::<font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>val_der<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font><font color='#5555FF'>=</font> thresh<font face='Lucida Console'>)</font>
                    <font color='#0000FF'>return</font> alpha;

                <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font> <font face='Lucida Console'>(</font>b<font color='#5555FF'>-</font>a<font face='Lucida Console'>)</font><font color='#5555FF'>*</font>val_der <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
                <b>{</b>
                    b <font color='#5555FF'>=</font> a;
                    b_val <font color='#5555FF'>=</font> a_val;
                    b_val_der <font color='#5555FF'>=</font> a_val_der;
                <b>}</b>

                a <font color='#5555FF'>=</font> alpha;
                a_val <font color='#5555FF'>=</font> val;
                a_val_der <font color='#5555FF'>=</font> val_der;
            <b>}</b>
        <b>}</b>
    <b>}</b>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>
        <font color='#0000FF'>typename</font> funct, 
        <font color='#0000FF'>typename</font> funct_der, 
        <font color='#0000FF'>typename</font> T
        <font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>void</u></font> <b><a name='find_min_quasi_newton'></a>find_min_quasi_newton</b> <font face='Lucida Console'>(</font>
        <font color='#0000FF'>const</font> funct<font color='#5555FF'>&amp;</font> f, 
        <font color='#0000FF'>const</font> funct_der<font color='#5555FF'>&amp;</font> der, 
        T<font color='#5555FF'>&amp;</font> x, 
        <font color='#0000FF'><u>double</u></font> min_f,
        <font color='#0000FF'><u>double</u></font> min_delta <font color='#5555FF'>=</font> <font color='#979000'>1</font>e<font color='#5555FF'>-</font><font color='#979000'>7</font> 
    <font face='Lucida Console'>)</font>
    <b>{</b>
        <font color='#009900'>// You get an error on this line when you pass in a global function to this function.
</font>        <font color='#009900'>// You have to either use a function object or pass a pointer to your global function
</font>        <font color='#009900'>// by taking its address using the &amp; operator.
</font>        <font color='#BB00BB'>COMPILE_TIME_ASSERT</font><font face='Lucida Console'>(</font>is_function<font color='#5555FF'>&lt;</font>funct<font color='#5555FF'>&gt;</font>::value <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>false</font><font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>COMPILE_TIME_ASSERT</font><font face='Lucida Console'>(</font>is_function<font color='#5555FF'>&lt;</font>funct_der<font color='#5555FF'>&gt;</font>::value <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>false</font><font face='Lucida Console'>)</font>;

        <font color='#BB00BB'>COMPILE_TIME_ASSERT</font><font face='Lucida Console'>(</font>is_matrix<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value<font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>DLIB_ASSERT</font> <font face='Lucida Console'>(</font>
            min_delta <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> x.<font color='#BB00BB'>nc</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>,
            "<font color='#CC0000'>\tdouble find_min_quasi_newton()</font>"
            <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\n\tYou have to supply column vectors to this function</font>"
            <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\n\tmin_delta: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> min_delta
            <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\n\tx.nc():    </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> x.<font color='#BB00BB'>nc</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>
        <font face='Lucida Console'>)</font>;

        T g, g2, s, Hg, gH;
        <font color='#0000FF'><u>double</u></font> alpha <font color='#5555FF'>=</font> <font color='#979000'>10</font>;

        matrix<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>double</u></font>,T::NR,T::NR<font color='#5555FF'>&gt;</font> <font color='#BB00BB'>H</font><font face='Lucida Console'>(</font>x.<font color='#BB00BB'>nr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>,x.<font color='#BB00BB'>nr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        T delta, gamma;

        H <font color='#5555FF'>=</font> identity_matrix<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>double</u></font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>H.<font color='#BB00BB'>nr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

        g <font color='#5555FF'>=</font> <font color='#BB00BB'>der</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font>;

        <font color='#0000FF'><u>double</u></font> f_value <font color='#5555FF'>=</font> min_f <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
        <font color='#0000FF'><u>double</u></font> old_f_value <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

        <font color='#009900'>// loop until the derivative is almost zero
</font>        <font color='#0000FF'>while</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>old_f_value <font color='#5555FF'>-</font> f_value<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> min_delta<font face='Lucida Console'>)</font>
        <b>{</b>
            old_f_value <font color='#5555FF'>=</font> f_value;

            s <font color='#5555FF'>=</font> <font color='#5555FF'>-</font>H<font color='#5555FF'>*</font>g;

            alpha <font color='#5555FF'>=</font> <font color='#BB00BB'>line_search</font><font face='Lucida Console'>(</font><font color='#BB00BB'>make_line_search_function</font><font face='Lucida Console'>(</font>f,x,s<font face='Lucida Console'>)</font>,<font color='#BB00BB'>make_line_search_function</font><font face='Lucida Console'>(</font>der,x,s<font face='Lucida Console'>)</font>,<font color='#979000'>0.01</font>, <font color='#979000'>0.9</font>,min_f, f_value<font face='Lucida Console'>)</font>;

            x <font color='#5555FF'>+</font><font color='#5555FF'>=</font> alpha<font color='#5555FF'>*</font>s;


            g2 <font color='#5555FF'>=</font> <font color='#BB00BB'>der</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font>;

            <font color='#009900'>// update H with the BFGS formula from (3.2.12) on page 55 of Fletcher 
</font>            delta <font color='#5555FF'>=</font> alpha<font color='#5555FF'>*</font>s;
            gamma <font color='#5555FF'>=</font> g2<font color='#5555FF'>-</font>g;

            Hg <font color='#5555FF'>=</font> H<font color='#5555FF'>*</font>gamma;
            gH <font color='#5555FF'>=</font> <font color='#BB00BB'>trans</font><font face='Lucida Console'>(</font><font color='#BB00BB'>trans</font><font face='Lucida Console'>(</font>gamma<font face='Lucida Console'>)</font><font color='#5555FF'>*</font>H<font face='Lucida Console'>)</font>;
            <font color='#0000FF'><u>double</u></font> gHg <font color='#5555FF'>=</font> <font color='#BB00BB'>trans</font><font face='Lucida Console'>(</font>gamma<font face='Lucida Console'>)</font><font color='#5555FF'>*</font>H<font color='#5555FF'>*</font>gamma;
            <font color='#0000FF'><u>double</u></font> dg <font color='#5555FF'>=</font> <font color='#BB00BB'>trans</font><font face='Lucida Console'>(</font>delta<font face='Lucida Console'>)</font><font color='#5555FF'>*</font>gamma;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>gHg <font color='#5555FF'>&lt;</font> std::numeric_limits<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>double</u></font><font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>infinity</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> dg <font color='#5555FF'>&lt;</font> std::numeric_limits<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>double</u></font><font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>infinity</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                dg <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            <b>{</b>
                H <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#979000'>1</font> <font color='#5555FF'>+</font> gHg<font color='#5555FF'>/</font>dg<font face='Lucida Console'>)</font><font color='#5555FF'>*</font>delta<font color='#5555FF'>*</font><font color='#BB00BB'>trans</font><font face='Lucida Console'>(</font>delta<font face='Lucida Console'>)</font><font color='#5555FF'>/</font><font face='Lucida Console'>(</font>dg<font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font>delta<font color='#5555FF'>*</font><font color='#BB00BB'>trans</font><font face='Lucida Console'>(</font>gH<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> Hg<font color='#5555FF'>*</font><font color='#BB00BB'>trans</font><font face='Lucida Console'>(</font>delta<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>/</font><font face='Lucida Console'>(</font>dg<font face='Lucida Console'>)</font>;
            <b>}</b>
            <font color='#0000FF'>else</font>
            <b>{</b>
                H <font color='#5555FF'>=</font> identity_matrix<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>double</u></font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>H.<font color='#BB00BB'>nr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
            <b>}</b>

            g.<font color='#BB00BB'>swap</font><font face='Lucida Console'>(</font>g2<font face='Lucida Console'>)</font>;
        <b>}</b>

    <b>}</b>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>
        <font color='#0000FF'>typename</font> funct,
        <font color='#0000FF'>typename</font> funct_der,
        <font color='#0000FF'>typename</font> T
        <font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>void</u></font> <b><a name='find_min_conjugate_gradient'></a>find_min_conjugate_gradient</b> <font face='Lucida Console'>(</font>
        <font color='#0000FF'>const</font> funct<font color='#5555FF'>&amp;</font> f,
        <font color='#0000FF'>const</font> funct_der<font color='#5555FF'>&amp;</font> der,
        T<font color='#5555FF'>&amp;</font> x,
        <font color='#0000FF'><u>double</u></font> min_f,
        <font color='#0000FF'><u>double</u></font> min_delta <font color='#5555FF'>=</font> <font color='#979000'>1</font>e<font color='#5555FF'>-</font><font color='#979000'>7</font>
    <font face='Lucida Console'>)</font>
    <b>{</b>
        <font color='#009900'>// You get an error on this line when you pass in a global function to this function.
</font>        <font color='#009900'>// You have to either use a function object or pass a pointer to your global function
</font>        <font color='#009900'>// by taking its address using the &amp; operator.
</font>        <font color='#BB00BB'>COMPILE_TIME_ASSERT</font><font face='Lucida Console'>(</font>is_function<font color='#5555FF'>&lt;</font>funct<font color='#5555FF'>&gt;</font>::value <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>false</font><font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>COMPILE_TIME_ASSERT</font><font face='Lucida Console'>(</font>is_function<font color='#5555FF'>&lt;</font>funct_der<font color='#5555FF'>&gt;</font>::value <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>false</font><font face='Lucida Console'>)</font>;

        <font color='#BB00BB'>COMPILE_TIME_ASSERT</font><font face='Lucida Console'>(</font>is_matrix<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value<font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>DLIB_ASSERT</font> <font face='Lucida Console'>(</font>
            min_delta <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> x.<font color='#BB00BB'>nc</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>,
            "<font color='#CC0000'>\tdouble find_min_conjugate_gradient()</font>"
            <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\n\tYou have to supply column vectors to this function</font>"
            <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\n\tmin_delta: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> min_delta
            <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\n\tx.nc():    </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> x.<font color='#BB00BB'>nc</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>
        <font face='Lucida Console'>)</font>;

        T g, g2, s;
        <font color='#0000FF'><u>double</u></font> alpha <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

        g <font color='#5555FF'>=</font> <font color='#BB00BB'>der</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font>;
        s <font color='#5555FF'>=</font> <font color='#5555FF'>-</font>g;

        <font color='#0000FF'><u>double</u></font> f_value <font color='#5555FF'>=</font> min_f <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
        <font color='#0000FF'><u>double</u></font> old_f_value <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

        <font color='#009900'>// loop until the derivative is almost zero
</font>        <font color='#0000FF'>while</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>old_f_value <font color='#5555FF'>-</font> f_value<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> min_delta<font face='Lucida Console'>)</font>
        <b>{</b>
            old_f_value <font color='#5555FF'>=</font> f_value;

            alpha <font color='#5555FF'>=</font> <font color='#BB00BB'>line_search</font><font face='Lucida Console'>(</font><font color='#BB00BB'>make_line_search_function</font><font face='Lucida Console'>(</font>f,x,s<font face='Lucida Console'>)</font>,<font color='#BB00BB'>make_line_search_function</font><font face='Lucida Console'>(</font>der,x,s<font face='Lucida Console'>)</font>,<font color='#979000'>0.001</font>, <font color='#979000'>0.010</font>,min_f, f_value<font face='Lucida Console'>)</font>;
            x <font color='#5555FF'>+</font><font color='#5555FF'>=</font> alpha<font color='#5555FF'>*</font>s;


            g2 <font color='#5555FF'>=</font> <font color='#BB00BB'>der</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font>;

            <font color='#0000FF'>const</font> <font color='#0000FF'><u>double</u></font> temp <font color='#5555FF'>=</font> <font color='#BB00BB'>trans</font><font face='Lucida Console'>(</font>g<font face='Lucida Console'>)</font><font color='#5555FF'>*</font>g;
            <font color='#009900'>// just stop if this value hits zero
</font>            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>std::<font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>temp<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font> std::numeric_limits<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>double</u></font><font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>epsilon</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                <font color='#0000FF'>break</font>;

            <font color='#009900'>// Use the Polak-Ribiere (4.1.12) conjugate gradient described by Fletcher on page 83
</font>            <font color='#0000FF'><u>double</u></font> b <font color='#5555FF'>=</font> <font color='#BB00BB'>trans</font><font face='Lucida Console'>(</font>g2<font color='#5555FF'>-</font>g<font face='Lucida Console'>)</font><font color='#5555FF'>*</font>g2<font color='#5555FF'>/</font><font face='Lucida Console'>(</font>temp<font face='Lucida Console'>)</font>;
            s <font color='#5555FF'>=</font> <font color='#5555FF'>-</font>g2 <font color='#5555FF'>+</font> b<font color='#5555FF'>*</font>s;

            g.<font color='#BB00BB'>swap</font><font face='Lucida Console'>(</font>g2<font face='Lucida Console'>)</font>;
        <b>}</b>

    <b>}</b>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>
        <font color='#0000FF'>typename</font> funct, 
        <font color='#0000FF'>typename</font> T
        <font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>void</u></font> <b><a name='find_min_quasi_newton2'></a>find_min_quasi_newton2</b> <font face='Lucida Console'>(</font>
        <font color='#0000FF'>const</font> funct<font color='#5555FF'>&amp;</font> f, 
        T<font color='#5555FF'>&amp;</font> x, 
        <font color='#0000FF'><u>double</u></font> min_f,
        <font color='#0000FF'><u>double</u></font> min_delta <font color='#5555FF'>=</font> <font color='#979000'>1</font>e<font color='#5555FF'>-</font><font color='#979000'>7</font>,
        <font color='#0000FF'><u>double</u></font> derivative_eps <font color='#5555FF'>=</font> <font color='#979000'>1</font>e<font color='#5555FF'>-</font><font color='#979000'>7</font>
    <font face='Lucida Console'>)</font>
    <b>{</b>
        <font color='#009900'>// You get an error on this line when you pass in a global function to this function.
</font>        <font color='#009900'>// You have to either use a function object or pass a pointer to your global function
</font>        <font color='#009900'>// by taking its address using the &amp; operator.
</font>        <font color='#BB00BB'>COMPILE_TIME_ASSERT</font><font face='Lucida Console'>(</font>is_function<font color='#5555FF'>&lt;</font>funct<font color='#5555FF'>&gt;</font>::value <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>false</font><font face='Lucida Console'>)</font>;

        <font color='#BB00BB'>COMPILE_TIME_ASSERT</font><font face='Lucida Console'>(</font>is_matrix<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value<font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>DLIB_ASSERT</font> <font face='Lucida Console'>(</font>
            min_delta <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> x.<font color='#BB00BB'>nc</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font>,
            "<font color='#CC0000'>\tdouble find_min_quasi_newton()</font>"
            <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\n\tYou have to supply column vectors to this function</font>"
            <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\n\tmin_delta:      </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> min_delta
            <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\n\tx.nc():         </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> x.<font color='#BB00BB'>nc</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>
            <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\n\tderivative_eps: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> derivative_eps 
        <font face='Lucida Console'>)</font>;

        T g, g2, s, Hg, gH;
        <font color='#0000FF'><u>double</u></font> alpha <font color='#5555FF'>=</font> <font color='#979000'>10</font>;

        matrix<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>double</u></font>,T::NR,T::NR<font color='#5555FF'>&gt;</font> <font color='#BB00BB'>H</font><font face='Lucida Console'>(</font>x.<font color='#BB00BB'>nr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>,x.<font color='#BB00BB'>nr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
        T delta, gamma;

        H <font color='#5555FF'>=</font> identity_matrix<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>double</u></font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>H.<font color='#BB00BB'>nr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;

        g <font color='#5555FF'>=</font> <font color='#BB00BB'>derivative</font><font face='Lucida Console'>(</font>f,derivative_eps<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font>;

        <font color='#0000FF'><u>double</u></font> f_value <font color='#5555FF'>=</font> min_f <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
        <font color='#0000FF'><u>double</u></font> old_f_value <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

        <font color='#009900'>// loop until the derivative is almost zero
</font>        <font color='#0000FF'>while</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>old_f_value <font color='#5555FF'>-</font> f_value<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> min_delta<font face='Lucida Console'>)</font>
        <b>{</b>
            old_f_value <font color='#5555FF'>=</font> f_value;

            s <font color='#5555FF'>=</font> <font color='#5555FF'>-</font>H<font color='#5555FF'>*</font>g;

            alpha <font color='#5555FF'>=</font> <font color='#BB00BB'>line_search</font><font face='Lucida Console'>(</font>
                            <font color='#BB00BB'>make_line_search_function</font><font face='Lucida Console'>(</font>f,x,s<font face='Lucida Console'>)</font>,
                            <font color='#BB00BB'>derivative</font><font face='Lucida Console'>(</font><font color='#BB00BB'>make_line_search_function</font><font face='Lucida Console'>(</font>f,x,s<font face='Lucida Console'>)</font>,derivative_eps<font face='Lucida Console'>)</font>,
                            <font color='#979000'>0.01</font>, <font color='#979000'>0.9</font>,min_f, f_value<font face='Lucida Console'>)</font>;

            x <font color='#5555FF'>+</font><font color='#5555FF'>=</font> alpha<font color='#5555FF'>*</font>s;


            g2 <font color='#5555FF'>=</font> <font color='#BB00BB'>derivative</font><font face='Lucida Console'>(</font>f,derivative_eps<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font>;

            <font color='#009900'>// update H with the BFGS formula from (3.2.12) on page 55 of Fletcher 
</font>            delta <font color='#5555FF'>=</font> alpha<font color='#5555FF'>*</font>s;
            gamma <font color='#5555FF'>=</font> g2<font color='#5555FF'>-</font>g;

            Hg <font color='#5555FF'>=</font> H<font color='#5555FF'>*</font>gamma;
            gH <font color='#5555FF'>=</font> <font color='#BB00BB'>trans</font><font face='Lucida Console'>(</font><font color='#BB00BB'>trans</font><font face='Lucida Console'>(</font>gamma<font face='Lucida Console'>)</font><font color='#5555FF'>*</font>H<font face='Lucida Console'>)</font>;
            <font color='#0000FF'><u>double</u></font> gHg <font color='#5555FF'>=</font> <font color='#BB00BB'>trans</font><font face='Lucida Console'>(</font>gamma<font face='Lucida Console'>)</font><font color='#5555FF'>*</font>H<font color='#5555FF'>*</font>gamma;
            <font color='#0000FF'><u>double</u></font> dg <font color='#5555FF'>=</font> <font color='#BB00BB'>trans</font><font face='Lucida Console'>(</font>delta<font face='Lucida Console'>)</font><font color='#5555FF'>*</font>gamma;
            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>gHg <font color='#5555FF'>&lt;</font> std::numeric_limits<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>double</u></font><font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>infinity</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> dg <font color='#5555FF'>&lt;</font> std::numeric_limits<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>double</u></font><font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>infinity</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font>
                dg <font color='#5555FF'>!</font><font color='#5555FF'>=</font> <font color='#979000'>0</font><font face='Lucida Console'>)</font>
            <b>{</b>
                H <font color='#5555FF'>+</font><font color='#5555FF'>=</font> <font face='Lucida Console'>(</font><font color='#979000'>1</font> <font color='#5555FF'>+</font> gHg<font color='#5555FF'>/</font>dg<font face='Lucida Console'>)</font><font color='#5555FF'>*</font>delta<font color='#5555FF'>*</font><font color='#BB00BB'>trans</font><font face='Lucida Console'>(</font>delta<font face='Lucida Console'>)</font><font color='#5555FF'>/</font><font face='Lucida Console'>(</font>dg<font face='Lucida Console'>)</font> <font color='#5555FF'>-</font> <font face='Lucida Console'>(</font>delta<font color='#5555FF'>*</font><font color='#BB00BB'>trans</font><font face='Lucida Console'>(</font>gH<font face='Lucida Console'>)</font> <font color='#5555FF'>+</font> Hg<font color='#5555FF'>*</font><font color='#BB00BB'>trans</font><font face='Lucida Console'>(</font>delta<font face='Lucida Console'>)</font><font face='Lucida Console'>)</font><font color='#5555FF'>/</font><font face='Lucida Console'>(</font>dg<font face='Lucida Console'>)</font>;
            <b>}</b>
            <font color='#0000FF'>else</font>
            <b>{</b>
                H <font color='#5555FF'>=</font> identity_matrix<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>double</u></font><font color='#5555FF'>&gt;</font><font face='Lucida Console'>(</font>H.<font color='#BB00BB'>nr</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>;
            <b>}</b>

            g.<font color='#BB00BB'>swap</font><font face='Lucida Console'>(</font>g2<font face='Lucida Console'>)</font>;
        <b>}</b>

    <b>}</b>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
    <font color='#0000FF'>template</font> <font color='#5555FF'>&lt;</font>
        <font color='#0000FF'>typename</font> funct,
        <font color='#0000FF'>typename</font> T
        <font color='#5555FF'>&gt;</font>
    <font color='#0000FF'><u>void</u></font> <b><a name='find_min_conjugate_gradient2'></a>find_min_conjugate_gradient2</b> <font face='Lucida Console'>(</font>
        <font color='#0000FF'>const</font> funct<font color='#5555FF'>&amp;</font> f,
        T<font color='#5555FF'>&amp;</font> x,
        <font color='#0000FF'><u>double</u></font> min_f,
        <font color='#0000FF'><u>double</u></font> min_delta <font color='#5555FF'>=</font> <font color='#979000'>1</font>e<font color='#5555FF'>-</font><font color='#979000'>7</font>,
        <font color='#0000FF'><u>double</u></font> derivative_eps <font color='#5555FF'>=</font> <font color='#979000'>1</font>e<font color='#5555FF'>-</font><font color='#979000'>7</font>
    <font face='Lucida Console'>)</font>
    <b>{</b>
        <font color='#009900'>// You get an error on this line when you pass in a global function to this function.
</font>        <font color='#009900'>// You have to either use a function object or pass a pointer to your global function
</font>        <font color='#009900'>// by taking its address using the &amp; operator.
</font>        <font color='#BB00BB'>COMPILE_TIME_ASSERT</font><font face='Lucida Console'>(</font>is_function<font color='#5555FF'>&lt;</font>funct<font color='#5555FF'>&gt;</font>::value <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>false</font><font face='Lucida Console'>)</font>;

        <font color='#BB00BB'>COMPILE_TIME_ASSERT</font><font face='Lucida Console'>(</font>is_matrix<font color='#5555FF'>&lt;</font>T<font color='#5555FF'>&gt;</font>::value<font face='Lucida Console'>)</font>;
        <font color='#BB00BB'>DLIB_ASSERT</font> <font face='Lucida Console'>(</font>
            min_delta <font color='#5555FF'>&gt;</font><font color='#5555FF'>=</font> <font color='#979000'>0</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> x.<font color='#BB00BB'>nc</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font> <font color='#5555FF'>=</font><font color='#5555FF'>=</font> <font color='#979000'>1</font> <font color='#5555FF'>&amp;</font><font color='#5555FF'>&amp;</font> derivative_eps <font color='#5555FF'>&gt;</font> <font color='#979000'>0</font>,
            "<font color='#CC0000'>\tdouble find_min_conjugate_gradient()</font>"
            <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\n\tYou have to supply column vectors to this function</font>"
            <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\n\tmin_delta:      </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> min_delta
            <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\n\tx.nc():         </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> x.<font color='#BB00BB'>nc</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font>
            <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> "<font color='#CC0000'>\n\tderivative_eps: </font>" <font color='#5555FF'>&lt;</font><font color='#5555FF'>&lt;</font> derivative_eps 
        <font face='Lucida Console'>)</font>;

        T g, g2, s;
        <font color='#0000FF'><u>double</u></font> alpha <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

        g <font color='#5555FF'>=</font> <font color='#BB00BB'>derivative</font><font face='Lucida Console'>(</font>f,derivative_eps<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font>;
        s <font color='#5555FF'>=</font> <font color='#5555FF'>-</font>g;

        <font color='#0000FF'><u>double</u></font> f_value <font color='#5555FF'>=</font> min_f <font color='#5555FF'>-</font> <font color='#979000'>1</font>;
        <font color='#0000FF'><u>double</u></font> old_f_value <font color='#5555FF'>=</font> <font color='#979000'>0</font>;

        <font color='#009900'>// loop until the derivative is almost zero
</font>        <font color='#0000FF'>while</font><font face='Lucida Console'>(</font>std::<font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>old_f_value <font color='#5555FF'>-</font> f_value<font face='Lucida Console'>)</font> <font color='#5555FF'>&gt;</font> min_delta<font face='Lucida Console'>)</font>
        <b>{</b>
            old_f_value <font color='#5555FF'>=</font> f_value;

            alpha <font color='#5555FF'>=</font> <font color='#BB00BB'>line_search</font><font face='Lucida Console'>(</font>
                        <font color='#BB00BB'>make_line_search_function</font><font face='Lucida Console'>(</font>f,x,s<font face='Lucida Console'>)</font>,
                        <font color='#BB00BB'>derivative</font><font face='Lucida Console'>(</font><font color='#BB00BB'>make_line_search_function</font><font face='Lucida Console'>(</font>f,x,s<font face='Lucida Console'>)</font>,derivative_eps<font face='Lucida Console'>)</font>,
                        <font color='#979000'>0.001</font>, <font color='#979000'>0.010</font>,min_f, f_value<font face='Lucida Console'>)</font>;

            x <font color='#5555FF'>+</font><font color='#5555FF'>=</font> alpha<font color='#5555FF'>*</font>s;

            g2 <font color='#5555FF'>=</font> <font color='#BB00BB'>derivative</font><font face='Lucida Console'>(</font>f,derivative_eps<font face='Lucida Console'>)</font><font face='Lucida Console'>(</font>x<font face='Lucida Console'>)</font>;

            <font color='#009900'>// Use the Polak-Ribiere (4.1.12) conjugate gradient described by Fletcher on page 83
</font>            <font color='#0000FF'>const</font> <font color='#0000FF'><u>double</u></font> temp <font color='#5555FF'>=</font> <font color='#BB00BB'>trans</font><font face='Lucida Console'>(</font>g<font face='Lucida Console'>)</font><font color='#5555FF'>*</font>g;
            <font color='#009900'>// just stop if this value hits zero
</font>            <font color='#0000FF'>if</font> <font face='Lucida Console'>(</font>std::<font color='#BB00BB'>abs</font><font face='Lucida Console'>(</font>temp<font face='Lucida Console'>)</font> <font color='#5555FF'>&lt;</font> std::numeric_limits<font color='#5555FF'>&lt;</font><font color='#0000FF'><u>double</u></font><font color='#5555FF'>&gt;</font>::<font color='#BB00BB'>epsilon</font><font face='Lucida Console'>(</font><font face='Lucida Console'>)</font><font face='Lucida Console'>)</font>
                <font color='#0000FF'>break</font>;

            <font color='#0000FF'><u>double</u></font> b <font color='#5555FF'>=</font> <font color='#BB00BB'>trans</font><font face='Lucida Console'>(</font>g2<font color='#5555FF'>-</font>g<font face='Lucida Console'>)</font><font color='#5555FF'>*</font>g2<font color='#5555FF'>/</font><font face='Lucida Console'>(</font>temp<font face='Lucida Console'>)</font>;
            s <font color='#5555FF'>=</font> <font color='#5555FF'>-</font>g2 <font color='#5555FF'>+</font> b<font color='#5555FF'>*</font>s;

            g.<font color='#BB00BB'>swap</font><font face='Lucida Console'>(</font>g2<font face='Lucida Console'>)</font>;
        <b>}</b>

    <b>}</b>

<font color='#009900'>// ----------------------------------------------------------------------------------------
</font>
<b>}</b>

<font color='#0000FF'>#endif</font> <font color='#009900'>// DLIB_OPTIMIZATIOn_H_
</font>

</pre></body></html>