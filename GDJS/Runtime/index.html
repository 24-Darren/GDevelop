<!DOCTYPE HTML>
<html>
<head>
	<title>pixi.js example 1</title>
	<style>
		body {
			margin: 0;
			padding: 0;
			background-color: #000000;
		}
	</style>
    <!-- Libs and GDJS core files -->
	<script src="libs/pixi.js"></script>
	<script src="libs/jquery.js"></script>
	<script src="libs/jshashtable.js"></script>
	<script src="gd.js"></script>
	<script src="commontools.js"></script>
	<script src="polygon.js"></script>
	<script src="force.js"></script>
	<script src="layer.js"></script>
	<script src="timer.js"></script>
	<script src="imagemanager.js"></script>
	<script src="runtimegame.js"></script>
	<script src="variable.js"></script>
	<script src="variablescontainer.js"></script>
	<script src="runtimescene.js"></script>
	<script src="runtimeobject.js"></script>
	<script src="spriteruntimeobject.js"></script>
	<script src="soundmanager.js"></script>
    
    <!-- Scripts for events -->
	<script src="runtimescenetools.js"></script>
	<script src="inputtools.js"></script>
	<script src="objecttools.js"></script>
	<script src="cameratools.js"></script>
	<script src="code.js"></script>

</head>
<body>
	<script>
    
    $( document ).ready( function() {
        $.ajax({type:"GET", url:"data.xml", dataType:"xml", success: launch});
    });
    
    
	
    var launch = function(project) {
        var isMSIE = /*@cc_on!@*/0;

        var game = gdjs.runtimeGame($(project).find("Project"));
    
        //Create a renderer
        var winWidth = $(project).find("Project").find("Info").find("WindowW").attr("value");
        var winHeight = $(project).find("Project").find("Info").find("WindowH").attr("value");
        var renderer = PIXI.autoDetectRenderer(winWidth, winHeight);
        document.body.appendChild(renderer.view); // add the renderer view element to the DOM
        
        //Bind keyboards and mouse events
        $(document).keydown(function(event) {
            game.onKeyPressed(event.keyCode);
        });
        $(document).keyup(function(event) {
            game.onKeyReleased(event.keyCode);
        });
        $(document).mousemove(function(e){
            game.onMouseMove(e.pageX, e.pageY);
        }); 
        renderer.view.onmousedown = function(e){
            game.onMouseButtonPressed(e.button === 2 ? 1 : 0);
            return false;
        };
        renderer.view.onmouseup = function(e){
            game.onMouseButtonReleased(e.button === 2 ? 1 : 0);
            return false;
        };
        renderer.view.onmouseout = function(e){
            game.onMouseButtonReleased(0);
            game.onMouseButtonReleased(1);
            game.onMouseWheel(0);
            return false;
        };
        window.addEventListener('click', function(e) {
            e.preventDefault();
            return false;
        }, false);
        renderer.view.oncontextmenu = function(event) {
            event.preventDefault();
            event.stopPropagation();
            return false;
        };
        renderer.view.onmousewheel = function (event){
            game.onMouseWheel(event.wheelDelta);
        }
        
        //Load all assets
        var loadingStage = new PIXI.Stage();
        var text = new PIXI.Text("Loading...", {font: "bold italic 60px Arvo", fill: "#3e1707", align: "center", stroke: "#a4410e", strokeThickness: 7});
        loadingStage.addChild(text);
        text.position.x = winWidth/2;
        text.position.y = winHeight/2;
        var loadingCount = 0;
        
        
        var assets = [];
        $(project).find("Resources").find("Resources").find("Resource").each( function() {
            if ( $(this).attr("file") ) {
                assets.push($(this).attr("file"));
            }
            console.log($(this).attr("file"));
        });
        var assetLoader = new PIXI.AssetLoader(assets);
        assetLoader.load();
        assetLoader.onComplete = onAssetsLoaded;
        assetLoader.onProgress = onAssetsLoadingProgress;
        
        function onAssetsLoaded() {
            //Create the scene to be played
            var currentScene = gdjs.runtimeScene(game, renderer);
            currentScene.loadFromScene($(project).find("Project").find("Scenes").find("Scene"));
            currentScene.setEventsFunction(gdjs.Nouvelle_32sc__4524neCode.func);
            
            requestAnimFrame( gameLoop );
            
            function gameLoop() {
                requestAnimFrame( gameLoop );
            
                currentScene.renderAndStep();
            }
        }
        
        function onAssetsLoadingProgress() {
            renderer.render(loadingStage);
            loadingCount++;
            text.setText(loadingCount.toString());
        }
    }

        
	</script>

	</body>
</html>
